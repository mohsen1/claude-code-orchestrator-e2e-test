{
  "version": 1,
  "issue": {
    "number": 377,
    "title": "Build SplitSync (Expense Sharing App)",
    "body": "\n# Product Requirements Document: SplitSync (Expense Sharing App)\n**Version:** 2.0 (Enhanced for Robustness & CI/CD)\n**Target:** Production-Ready MVP\n**Deployment Strategy:** Dockerized Node.js Server (VPS/Railway/Fly.io) due to SQLite + Socket.io constraints.\n\n---\n\n## 1. Architectural Overview & Robustness Principles\nTo achieve high robustness and production readiness, we are moving beyond a basic \"tutorial\" structure.\n\n*   **Type Safety:** End-to-end type safety using TypeScript, Zod (validation), and Drizzle ORM (strictly typed SQL).\n*   **Atomic Transactions:** All financial data (expenses, settlements) must use database transactions to ensure data integrity.\n*   **Deployment Architecture:** Since we are using SQLite (local file) and Socket.io (stateful connections), we cannot use standard Vercel Serverless. We will use a **Custom Next.js Server** wrapped in Docker.\n*   **Validation:** \"Trust nothing.\" All inputs (API & Form) are validated against Zod schemas before processing.\n\n---\n\n## 2. Enhanced Tech Stack\nWe are augmenting the original stack to ensure the app is maintainable and testable.\n\n| Layer | Technology | Justification for Robustness |\n| :--- | :--- | :--- |\n| **Framework** | **Next.js 14 (App Router)** | Using the `standalone` build output for Docker optimization. |\n| **Language** | **TypeScript** | Strict mode enabled. No `any` types allowed. |\n| **Database** | **SQLite** + **better-sqlite3** | Embedded, fast. Data stored on a persistent Docker volume. |\n| **ORM** | **Drizzle ORM** | Better performance than Prisma, strict SQL types, native support for `better-sqlite3`. |\n| **Validation** | **Zod** | Runtime schema validation for forms and API routes. |\n| **Auth** | **NextAuth.js (v5)** | Handling sessions, OAuth, and JWT encryption. |\n| **Real-time** | **Socket.io** | Mounted on the same HTTP server as Next.js for shared context. |\n| **UI/UX** | **Tailwind + shadcn/ui** | Accessible, keyboard navigable components. |\n| **Forms** | **React Hook Form** | Managed form state synced with Zod schemas. |\n| **Testing** | **Vitest** | Unit testing for utility logic and API endpoints. |\n| **CI/CD** | **GitHub Actions** | Automated linting, building, and type-checking. |\n\n---\n\n## 3. Database Schema & Data Integrity\nWe will use **Drizzle ORM** to define the schema. To ensure robustness, we enforce foreign keys and cascading deletes where appropriate.\n\n### Core Models\n\n1.  **Users**\n    *   `id` (UUID), `name`, `email` (Unique), `image`, `hashedPassword` (nullable for OAuth), `createdAt`.\n2.  **Groups**\n    *   `id` (UUID), `name`, `currency` (default USD), `createdBy` (FK -> User).\n3.  **GroupMembers**\n    *   Composite Key (`groupId`, `userId`).\n    *   `joinedAt`, `role` (Admin/Member).\n4.  **Expenses**\n    *   `id` (UUID), `groupId` (FK), `payerId` (FK), `amount` (Integer - store cents/lowest unit to avoid float errors), `description`, `date`.\n5.  **ExpenseSplits** (The robustness layer for splitting)\n    *   `expenseId` (FK), `userId` (FK), `amount` (The exact amount this person owes).\n    *   *Constraint:* Sum of `ExpenseSplits` must equal `Expenses.amount`.\n\n### Robustness Requirement: Floating Point Math\n*   **Strict Rule:** Money is **never** stored as a `float`. It is stored as an `Integer` (e.g., $10.50 = `1050`).\n*   All calculations happen in integers; formatting happens only at the UI layer.\n\n---\n\n## 4. Authentication & Security Specifications\nThis section details the requirements to make the app \"deploy ready\" for Auth.\n\n### 4.1. NextAuth Configuration\n*   **Session Strategy:** JWT (JSON Web Tokens). Since we are using a custom server, JWT avoids database locking on every request.\n*   **Providers:**\n    1.  **Google OAuth:** Requires `GOOGLE_CLIENT_ID` and `GOOGLE_CLIENT_SECRET`.\n    2.  **Credentials (Email/Pass):** requires bcrypt hashing.\n*   **Pages:** Custom styled `signin` page (overriding default NextAuth look).\n\n### 4.2. Middleware & Protection\n*   **Middleware.ts:** Must run on all routes except `/login`, `/register`, and `/api/auth`.\n*   **Group Security:** API routes regarding Groups must verify:\n    1.  The user is authenticated.\n    2.  The user is a member of that specific group (RBAC).\n\n---\n\n## 5. Real-Time Architecture (Socket.io)\nTo make this deployable, we cannot rely on Vercel's API routes for WebSockets. We must implement a **Custom Server entry point**.\n\n### 5.1. Server Setup (`server.ts`)\nInstead of `next start`, the production command will execute a custom Node server:\n\n```typescript\n// Conceptual architecture for robustness\nimport { createServer } from \"node:http\";\nimport next from \"next\";\nimport { Server } from \"socket.io\";\n\nconst app = next({ dev: process.env.NODE_ENV !== \"production\" });\nconst handler = app.getRequestHandler();\n\napp.prepare().then(() => {\n  const httpServer = createServer(handler);\n  const io = new Server(httpServer);\n\n  io.on(\"connection\", (socket) => {\n    // Robustness: Join rooms based on Group IDs\n    socket.on(\"join_group\", (groupId) => {\n      // Security: Validate user has access to group before joining\n      socket.join(groupId);\n    });\n  });\n\n  httpServer.listen(3000);\n});\n```\n\n### 5.2. Event Consistency\n*   **Optimistic UI:** The frontend should update immediately upon adding an expense.\n*   **Socket Fallback:** If the socket fails, the dashboard must have a \"Pull to Refresh\" or SWR/Tanstack Query revalidation trigger to ensure data consistency.\n\n\n## 6. Detailed Feature Specifications & Robustness Logic\n\nTo ensure the \"robustness\" requested, we define strictly how features handle edge cases, particularly regarding money math.\n\n### 6.1. Group Management\n*   **Create Group:** User inputs name and default currency.\n    *   *Robustness:* Backend verifies name length (min 3 chars). Creates a transaction to insert Group -> Insert Creator as Admin -> Create default \"General\" category.\n*   **Invite Members:**\n    *   **Method:** Generate a unique invite link (e.g., `app.com/invite/{uuid}`).\n    *   *Security:* The invite link should expire after 7 days or 100 uses (configurable).\n    *   *UX:* When a user clicks, if not logged in -> redirect to Login -> then redirect to Group Join action.\n\n### 6.2. Expense Logic & The \"Cent Problem\"\n*   **Input:** Total Amount (e.g., $100.00), Payer, Description.\n*   **Splitting Algorithm:**\n    *   Expenses are split equally by default.\n    *   **Robustness Rule:** If an amount does not split evenly (e.g., $100.00 / 3 people), the system must distribute the remainder penny-by-penny to random members to ensure `Sum(Splits) === TotalAmount`.\n    *   *Example:* $100.00 / 3 = [33.34, 33.33, 33.33].\n*   **Database Transaction:**\n    1.  Create `Expense` record.\n    2.  Create `ExpenseSplit` records for all members.\n    3.  Emit `socket.io` event `expense_added` to the group room.\n\n### 6.3. Settlement Algorithm (Graph Simplification)\n*   **Problem:** User A owes B $10. B owes C $10.\n*   **Optimization:** The system should display the *Net Balance* per user.\n    *   User A: -$10\n    *   User B: $0\n    *   User C: +$10\n*   **Settle Up Action:** A record is created indicating a payment from User A to User C.\n    *   *Validation:* Settlements cannot be negative.\n    *   *UI:* \"Settle Up\" modal shows exactly who owes whom based on the simplified debt graph.\n\n---\n\n## 7. CI/CD Pipeline (GitHub Actions)\n\nWe require a Continuous Integration pipeline to prevent bad code from reaching the main branch.\n\n**File:** `.github/workflows/ci.yml`\n\n```yaml\nname: CI & Robustness Checks\n\non:\n  push:\n    branches: [main]\n  pull_request:\n    branches: [main]\n\njobs:\n  quality-check:\n    name: Lint, Typecheck & Test\n    runs-on: ubuntu-latest\n    steps:\n      - name: Checkout Repo\n        uses: actions/checkout@v4\n\n      - name: Setup Node\n        uses: actions/setup-node@v4\n        with:\n          node-version: 20\n          cache: 'npm'\n\n      - name: Install Dependencies\n        run: npm ci\n\n      # 1. Static Analysis (Catch syntax/style errors)\n      - name: Lint\n        run: npm run lint\n\n      # 2. Type Safety (Catch TS errors before build)\n      - name: Type Check\n        run: tsc --noEmit\n\n      # 3. Unit Tests (Business logic verification)\n      - name: Run Vitest\n        run: npm run test\n\n  build-check:\n    name: Dry Run Build\n    needs: quality-check\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - uses: actions/setup-node@v4\n        with:\n          node-version: 20\n          cache: 'npm'\n      - run: npm ci\n      \n      # 4. Build Verification (Ensures Next.js build passes)\n      - name: Next Build\n        run: npm run build\n        env:\n          NEXT_PUBLIC_API_URL: \"http://localhost:3000\"\n          # Mock secrets for build process\n          AUTH_SECRET: \"mock-secret\"\n```\n\n---\n\n## 8. Docker Configuration & Persistence\n\nSince we are using **SQLite**, the database is a file. In Docker, if the container restarts, the file is lost *unless* mounted to a volume.\n\n**File:** `Dockerfile` (Production Optimized)\n\n```dockerfile\n# Stage 1: Builder\nFROM node:20-alpine AS builder\nWORKDIR /app\nCOPY package*.json ./\nRUN npm ci\nCOPY . .\n# Disable telemetry for privacy\nENV NEXT_TELEMETRY_DISABLED 1\n# Build the Next.js app\nRUN npm run build\n\n# Stage 2: Runner\nFROM node:20-alpine AS runner\nWORKDIR /app\nENV NODE_ENV production\nENV NEXT_TELEMETRY_DISABLED 1\n\n# Create a non-root user for security\nRUN addgroup --system --gid 1001 nodejs\nRUN adduser --system --uid 1001 nextjs\n\n# Copy necessary files for standalone mode\nCOPY --from=builder /app/public ./public\nCOPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./\nCOPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static\n# Copy custom server entry point\nCOPY --from=builder --chown=nextjs:nodejs /app/server.ts ./server.ts \n# Copy database folder structure (files will be mounted here)\nRUN mkdir -p /app/db && chown nextjs:nodejs /app/db\n\nUSER nextjs\n\nEXPOSE 3000\nENV PORT 3000\nENV HOSTNAME \"0.0.0.0\"\n\n# Start Custom Server (Socket.io + Next)\nCMD [\"node\", \"server.js\"] \n# Note: You need to compile server.ts to js during build or use ts-node in production\n```\n\n**Docker Compose (for local prod simulation):**\n\n```yaml\nversion: '3.8'\nservices:\n  web:\n    build: .\n    ports:\n      - \"3000:3000\"\n    volumes:\n      - ./sqlite_data:/app/db  # CRITICAL: Persist DB file\n    environment:\n      - DATABASE_URL=file:/app/db/splitsync.sqlite\n      - AUTH_SECRET=your_super_secure_secret\n```\n\n---\n\n## 9. Deployment & Documentation Guide\n\nThis section acts as the `README.md` instructions for the DevOps engineer or developer deploying the app.\n\n### 9.1. Pre-Deployment Secrets Generation\n1.  **Generate Auth Secret:**\n    Run `openssl rand -base64 32` in your terminal. Save this as `AUTH_SECRET`.\n2.  **Google OAuth Setup:**\n    *   Go to Google Cloud Console -> APIs & Services -> Credentials.\n    *   Create OAuth Client ID.\n    *   **Authorized Redirect URI:** `https://<your-domain.com>/api/auth/callback/google`.\n    *   Save `GOOGLE_CLIENT_ID` and `GOOGLE_CLIENT_SECRET`.\n\n### 9.2. Environment Variables (.env.production)\nEnsure these are set in your VPS, Railway, or Fly.io dashboard:\n\n```env\n# App\nNODE_ENV=production\nNEXT_PUBLIC_APP_URL=https://your-domain.com\n\n# Database (Ensure this path matches your Docker Volume mount)\nDATABASE_URL=\"file:/app/db/splitsync.sqlite\"\n\n# Auth\nAUTH_SECRET=\"<generated-openssl-string>\"\nAUTH_URL=https://your-domain.com/api/auth \n\n# OAuth\nGOOGLE_CLIENT_ID=\"<from-google-console>\"\nGOOGLE_CLIENT_SECRET=\"<from-google-console>\"\n```\n\n### 9.3. First-Time Initialization\nBecause SQLite is embedded, you must run migrations *inside* the container or before deployment if using a volume mount.\n\n**Recommended Production Command:**\nAdd this to your `package.json` scripts so it runs on container startup if the DB is missing, or manually trigger it via exec:\n\n```bash\n# Connect to running container\ndocker exec -it splitsync-container /bin/sh\n\n# Run Drizzle Migrations\nnpm run db:push\n```\n\n### 9.4. Monitoring & Logs\n*   **Health Check:** Implement a route at `/api/health` that returns `200 OK` if the DB connection is active.\n*   **Logs:** Since we are using Docker, logs should be directed to `stdout` so they can be captured by the hosting provider (AWS CloudWatch, Portainer, etc.)."
  },
  "repo": {
    "owner": "mohsen1",
    "name": "claude-code-orchestrator-e2e-test"
  },
  "phase": "project_setup",
  "workBranch": "cco/377-build-splitsync-expense-sharing-app",
  "baseBranch": "main",
  "ems": [
    {
      "id": 0,
      "task": "Initialize project foundation: create Next.js 14 app with TypeScript strict mode, configure .gitignore, package.json with all dependencies (NextAuth, Drizzle, Socket.io, Zod, React Hook Form, shadcn/ui, Vitest), tsconfig.json, and shared types directory with common interfaces (User, Group, Expense schemas)",
      "focusArea": "Project Setup",
      "branch": "cco/issue-377-setup",
      "status": "pending",
      "workers": [],
      "reviewsAddressed": 0
    }
  ],
  "config": {
    "maxEms": 10,
    "maxWorkersPerEm": 3,
    "reviewWaitMinutes": 4,
    "prLabel": "cco"
  },
  "createdAt": "2026-01-20T20:58:54.231Z",
  "updatedAt": "2026-01-20T20:59:27.221Z",
  "analysisSummary": "Build SplitSync, a production-ready expense sharing application with Next.js 14, TypeScript, SQLite (Drizzle ORM), NextAuth.js, and Socket.io real-time updates. Features include group management, robust expense splitting with integer math to avoid floating-point errors, settlement calculations, and comprehensive CI/CD with Docker deployment.",
  "projectSetup": {
    "completed": false
  },
  "pendingEMs": [
    {
      "id": 1,
      "task": "Design and implement Drizzle ORM database schema with SQLite: create db directory, configure Drizzle with better-sqlite3, define all tables (Users, Groups, GroupMembers, Expenses, ExpenseSplits, Settlements, Invites) with proper foreign keys, create migration files, and implement database connection utilities",
      "focusArea": "Database Schema & ORM",
      "branch": "cco/issue-377-em-1",
      "status": "pending",
      "workers": [],
      "reviewsAddressed": 0
    },
    {
      "id": 2,
      "task": "Implement NextAuth.js v5 authentication: configure JWT strategy, setup Google OAuth provider and Credentials provider with bcrypt, create custom signin/register pages in app/auth/, implement middleware.ts for route protection, and create session management utilities",
      "focusArea": "Authentication & Security",
      "branch": "cco/issue-377-em-2",
      "status": "pending",
      "workers": [],
      "reviewsAddressed": 0
    },
    {
      "id": 3,
      "task": "Build custom Next.js server with Socket.io integration: create server.ts entry point, configure Socket.io with room-based groups (join_group event), implement socket event handlers (expense_added, expense_updated, group_updated), setup authentication middleware for socket connections",
      "focusArea": "Real-Time Socket Server",
      "branch": "cco/issue-377-em-3",
      "status": "pending",
      "workers": [],
      "reviewsAddressed": 0
    },
    {
      "id": 4,
      "task": "Create group management API routes and business logic: implement POST/GET/DELETE for groups (app/api/groups/), member invitation system with expiring invite links (app/api/invite/), group member management with RBAC (admin/member roles), and transactional database operations",
      "focusArea": "Group Management APIs",
      "branch": "cco/issue-377-em-4",
      "status": "pending",
      "workers": [],
      "reviewsAddressed": 0
    },
    {
      "id": 5,
      "task": "Implement expense management APIs with robust integer-based money math: create expense CRUD endpoints (app/api/expenses/), implement equal-split algorithm with remainder distribution (e.g., $100/3 = [33.34, 33.33, 33.33]), use database transactions for Expense + ExpenseSplits creation, integrate Socket.io events for real-time updates",
      "focusArea": "Expense Management APIs",
      "branch": "cco/issue-377-em-5",
      "status": "pending",
      "workers": [],
      "reviewsAddressed": 0
    },
    {
      "id": 6,
      "task": "Build settlement system: implement net balance calculation algorithm to simplify debt graphs, create settlement API endpoints (app/api/settlements/), generate settlement records (who owes whom), validation to prevent negative settlements, and settlement history tracking",
      "focusArea": "Settlement & Balance Logic",
      "branch": "cco/issue-377-em-6",
      "status": "pending",
      "workers": [],
      "reviewsAddressed": 0
    },
    {
      "id": 7,
      "task": "Create frontend UI for authentication and group management: build signin/register pages with form validation, group list view, create group modal with currency selection, group detail page, invite link generation UI, member management interface using shadcn/ui components and React Hook Form with Zod validation",
      "focusArea": "Auth & Group UI",
      "branch": "cco/issue-377-em-7",
      "status": "pending",
      "workers": [],
      "reviewsAddressed": 0
    },
    {
      "id": 8,
      "task": "Build expense management UI: create expense list view with filtering, add expense modal with amount/description/payer/split inputs, expense detail/edit/delete functionality, display currency formatting from integer amounts, implement optimistic UI updates with Socket.io fallback",
      "focusArea": "Expense UI",
      "branch": "cco/issue-377-em-8",
      "status": "pending",
      "workers": [],
      "reviewsAddressed": 0
    },
    {
      "id": 9,
      "task": "Implement settlement UI and dashboard: create balance overview showing net balances per user, settle up modal with suggested payments (who pays whom), settlement history view, visual indicators for positive/negative balances, confirm payment flow",
      "focusArea": "Settlement & Dashboard UI",
      "branch": "cco/issue-377-em-9",
      "status": "pending",
      "workers": [],
      "reviewsAddressed": 0
    },
    {
      "id": 10,
      "task": "Set up CI/CD pipeline and Docker deployment: create .github/workflows/ci.yml with lint/typecheck/test/build jobs, write Dockerfile with multi-stage build (builder/runner) for Next.js standalone mode, configure docker-compose.yml with SQLite volume persistence, implement /api/health endpoint, create deployment documentation (README.md with setup instructions)",
      "focusArea": "CI/CD & Deployment",
      "branch": "cco/issue-377-em-10",
      "status": "pending",
      "workers": [],
      "reviewsAddressed": 0
    }
  ]
}