{
  "version": 1,
  "issue": {
    "number": 401,
    "title": "Build SplitSync (Expense Sharing App)",
    "body": "# Product Requirements Document: SplitSync (Expense Sharing App)\n**Version:** 2.0 (Enhanced for Robustness & CI/CD)\n**Target:** Production-Ready MVP\n**Deployment Strategy:** Dockerized Node.js Server (VPS/Railway/Fly.io) due to SQLite + Socket.io constraints.\n\n---\n\n## 1. Architectural Overview & Robustness Principles\nTo achieve high robustness and production readiness, we are moving beyond a basic \"tutorial\" structure.\n\n*   **Type Safety:** End-to-end type safety using TypeScript, Zod (validation), and Drizzle ORM (strictly typed SQL).\n*   **Atomic Transactions:** All financial data (expenses, settlements) must use database transactions to ensure data integrity.\n*   **Deployment Architecture:** Since we are using SQLite (local file) and Socket.io (stateful connections), we cannot use standard Vercel Serverless. We will use a **Custom Next.js Server** wrapped in Docker.\n*   **Validation:** \"Trust nothing.\" All inputs (API & Form) are validated against Zod schemas before processing.\n\n---\n\n## 2. Enhanced Tech Stack\nWe are augmenting the original stack to ensure the app is maintainable and testable.\n\n| Layer | Technology | Justification for Robustness |\n| :--- | :--- | :--- |\n| **Framework** | **Next.js 14 (App Router)** | Using the `standalone` build output for Docker optimization. |\n| **Language** | **TypeScript** | Strict mode enabled. No `any` types allowed. |\n| **Database** | **SQLite** + **better-sqlite3** | Embedded, fast. Data stored on a persistent Docker volume. |\n| **ORM** | **Drizzle ORM** | Better performance than Prisma, strict SQL types, native support for `better-sqlite3`. |\n| **Validation** | **Zod** | Runtime schema validation for forms and API routes. |\n| **Auth** | **NextAuth.js (v5)** | Handling sessions, OAuth, and JWT encryption. |\n| **Real-time** | **Socket.io** | Mounted on the same HTTP server as Next.js for shared context. |\n| **UI/UX** | **Tailwind + shadcn/ui** | Accessible, keyboard navigable components. |\n| **Forms** | **React Hook Form** | Managed form state synced with Zod schemas. |\n| **Testing** | **Vitest** | Unit testing for utility logic and API endpoints. |\n| **CI/CD** | **GitHub Actions** | Automated linting, building, and type-checking. |\n\n---\n\n## 3. Database Schema & Data Integrity\nWe will use **Drizzle ORM** to define the schema. To ensure robustness, we enforce foreign keys and cascading deletes where appropriate.\n\n### Core Models\n\n1.  **Users**\n    *   `id` (UUID), `name`, `email` (Unique), `image`, `hashedPassword` (nullable for OAuth), `createdAt`.\n2.  **Groups**\n    *   `id` (UUID), `name`, `currency` (default USD), `createdBy` (FK -> User).\n3.  **GroupMembers**\n    *   Composite Key (`groupId`, `userId`).\n    *   `joinedAt`, `role` (Admin/Member).\n4.  **Expenses**\n    *   `id` (UUID), `groupId` (FK), `payerId` (FK), `amount` (Integer - store cents/lowest unit to avoid float errors), `description`, `date`.\n5.  **ExpenseSplits** (The robustness layer for splitting)\n    *   `expenseId` (FK), `userId` (FK), `amount` (The exact amount this person owes).\n    *   *Constraint:* Sum of `ExpenseSplits` must equal `Expenses.amount`.\n\n### Robustness Requirement: Floating Point Math\n*   **Strict Rule:** Money is **never** stored as a `float`. It is stored as an `Integer` (e.g., $10.50 = `1050`).\n*   All calculations happen in integers; formatting happens only at the UI layer.\n\n---\n\n## 4. Authentication & Security Specifications\nThis section details the requirements to make the app \"deploy ready\" for Auth.\n\n### 4.1. NextAuth Configuration\n*   **Session Strategy:** JWT (JSON Web Tokens). Since we are using a custom server, JWT avoids database locking on every request.\n*   **Providers:**\n    1.  **Google OAuth:** Requires `GOOGLE_CLIENT_ID` and `GOOGLE_CLIENT_SECRET`.\n    2.  **Credentials (Email/Pass):** requires bcrypt hashing.\n*   **Pages:** Custom styled `signin` page (overriding default NextAuth look).\n\n### 4.2. Middleware & Protection\n*   **Middleware.ts:** Must run on all routes except `/login`, `/register`, and `/api/auth`.\n*   **Group Security:** API routes regarding Groups must verify:\n    1.  The user is authenticated.\n    2.  The user is a member of that specific group (RBAC).\n\n---\n\n## 5. Real-Time Architecture (Socket.io)\nTo make this deployable, we cannot rely on Vercel's API routes for WebSockets. We must implement a **Custom Server entry point**.\n\n### 5.1. Server Setup (`server.ts`)\nInstead of `next start`, the production command will execute a custom Node server:\n\n```typescript\nimport { createServer } from \"node:http\";\nimport next from \"next\";\nimport { Server } from \"socket.io\";\n\nconst app = next({ dev: process.env.NODE_ENV \\!== \"production\" });\nconst handler = app.getRequestHandler();\n\napp.prepare().then(() => {\n  const httpServer = createServer(handler);\n  const io = new Server(httpServer);\n\n  io.on(\"connection\", (socket) => {\n    socket.on(\"join_group\", (groupId) => {\n      socket.join(groupId);\n    });\n  });\n\n  httpServer.listen(3000);\n});\n```\n\n---\n\n## 6. Detailed Feature Specifications\n\n### 6.1. Group Management\n*   **Create Group:** User inputs name and default currency.\n    *   *Robustness:* Backend verifies name length (min 3 chars). Creates a transaction to insert Group -> Insert Creator as Admin -> Create default \"General\" category.\n*   **Invite Members:**\n    *   **Method:** Generate a unique invite link (e.g., `app.com/invite/{uuid}`).\n    *   **Security:** The invite link should expire after 7 days or 100 uses (configurable).\n\n### 6.2. Expense Logic & The \"Cent Problem\"\n*   **Input:** Total Amount (e.g., $100.00), Payer, Description.\n*   **Splitting Algorithm:**\n    *   Expenses are split equally by default.\n    *   **Robustness Rule:** If an amount does not split evenly (e.g., $100.00 / 3 people), the system must distribute the remainder penny-by-penny to random members to ensure `Sum(Splits) === TotalAmount`.\n    *   *Example:* $100.00 / 3 = [33.34, 33.33, 33.33].\n*   **Database Transaction:**\n    1.  Create `Expense` record.\n    2.  Create `ExpenseSplit` records for all members.\n    3.  Emit `socket.io` event `expense_added` to the group room.\n\n### 6.3. Settlement Algorithm (Graph Simplification)\n*   **Problem:** User A owes B $10. B owes C $10.\n*   **Optimization:** The system should display the *Net Balance* per user.\n    *   User A: -$10\n    *   User B: $0\n    *   User C: +$10\n*   **Settle Up Action:** A record is created indicating a payment from User A to User C.\n    *   *Validation:* Settlements cannot be negative.\n\n---\n\n## 7. CI/CD Pipeline (GitHub Actions)\n\n**File:** `.github/workflows/ci.yml`\n\n```yaml\nname: CI & Robustness Checks\n\non:\n  push:\n    branches: [main]\n  pull_request:\n    branches: [main]\n\njobs:\n  quality-check:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - uses: actions/setup-node@v4\n        with:\n          node-version: 20\n          cache: 'npm'\n      - run: npm ci\n      - run: npm run lint\n      - run: tsc --noEmit\n      - run: npm run test\n\n  build-check:\n    needs: quality-check\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - uses: actions/setup-node@v4\n        with:\n          node-version: 20\n          cache: 'npm'\n      - run: npm ci\n      - run: npm run build\n        env:\n          NEXT_PUBLIC_API_URL: \"http://localhost:3000\"\n          AUTH_SECRET: \"mock-secret\"\n```\n\n---\n\n## 8. Docker Configuration & Persistence\n\n**File:** `Dockerfile` (Production Optimized)\n\n```dockerfile\nFROM node:20-alpine AS builder\nWORKDIR /app\nCOPY package*.json ./\nRUN npm ci\nCOPY . .\nRUN npm run build\n\nFROM node:20-alpine AS runner\nWORKDIR /app\nENV NODE_ENV production\nRUN addgroup --system --gid 1001 nodejs\nRUN adduser --system --uid 1001 nextjs\nCOPY --from=builder /app/public ./public\nCOPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./\nCOPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static\nUSER nextjs\nEXPOSE 3000\nCMD [\"node\", \"server.js\"]\n```\n\n---\n\n**Note:** 13th attempt. Auto-merge fix verified in attempt #12 - 2/3 PRs auto-merged after Copilot reviews. Continuing to build SplitSync app."
  },
  "repo": {
    "owner": "mohsen1",
    "name": "claude-code-orchestrator-e2e-test"
  },
  "phase": "project_setup",
  "workBranch": "cco/401-build-splitsync-expense-sharing-app",
  "baseBranch": "main",
  "ems": [
    {
      "id": 0,
      "task": "Initialize project with Next.js 14, TypeScript, and all foundational configuration files (.gitignore, package.json with all dependencies, tsconfig.json, next.config.js, .env.example, ESLint, Prettier). Create shared types directory (src/types/) with all common interfaces (User, Group, Expense, Settlement, API response types). Setup Vitest testing configuration.",
      "focusArea": "Project Setup",
      "branch": "cco/issue-401-setup",
      "status": "pending",
      "workers": [],
      "reviewsAddressed": 0
    }
  ],
  "config": {
    "maxEms": 10,
    "maxWorkersPerEm": 3,
    "reviewWaitMinutes": 4,
    "prLabel": "cco"
  },
  "createdAt": "2026-01-21T04:02:03.723Z",
  "updatedAt": "2026-01-21T04:02:40.718Z",
  "analysisSummary": "Implement SplitSync - a production-ready expense sharing app with Next.js 14, SQLite/Drizzle ORM, Socket.io real-time updates, NextAuth.js authentication, and Docker deployment. Features include group management, expense splitting with integer-based math, settlement calculations, and comprehensive CI/CD pipeline.",
  "projectSetup": {
    "completed": false
  },
  "pendingEMs": [
    {
      "id": 1,
      "task": "Implement NextAuth.js v5 authentication system with JWT strategy. Configure Google OAuth and Credentials (email/password) providers with bcrypt hashing. Create custom signin/register pages in src/app/auth/. Implement session management and middleware for route protection in src/middleware.ts. Create API routes for user registration and password management.",
      "focusArea": "Authentication System",
      "branch": "cco/issue-401-em-1",
      "status": "pending",
      "workers": [],
      "reviewsAddressed": 0
    },
    {
      "id": 2,
      "task": "Build custom Next.js server with Socket.io integration (server.ts). Implement WebSocket event handlers for real-time expense updates, group joins, and settlements. Create Socket.io client utility in src/lib/socket.ts. Implement room-based communication for groups and connection lifecycle management. Ensure Socket.io works with Next.js standalone build output.",
      "focusArea": "Real-Time Socket.io Server",
      "branch": "cco/issue-401-em-2",
      "status": "pending",
      "workers": [],
      "reviewsAddressed": 0
    },
    {
      "id": 3,
      "task": "Create all API routes for group management: create group (src/app/api/groups/route.ts), get group details (src/app/api/groups/[id]/route.ts), add/remove members, update group settings, generate and validate invite links. Implement RBAC to verify group membership and admin permissions. All routes must use Zod validation and database transactions.",
      "focusArea": "Group Management API",
      "branch": "cco/issue-401-em-3",
      "status": "pending",
      "workers": [],
      "reviewsAddressed": 0
    },
    {
      "id": 4,
      "task": "Build expense management API with integer-based math (no floats). Create routes for adding expenses (src/app/api/expenses/route.ts), expense details, and deletion. Implement robust splitting algorithm that handles remainder distribution (e.g., $100/3 = [33.34, 33.33, 33.33]). Use database transactions to ensure ExpenseSplits sum equals Expense.amount. Emit Socket.io events on changes.",
      "focusArea": "Expense API & Split Logic",
      "branch": "cco/issue-401-em-4",
      "status": "pending",
      "workers": [],
      "reviewsAddressed": 0
    },
    {
      "id": 5,
      "task": "Implement settlement calculation and tracking API. Create graph simplification algorithm to calculate net balances (who owes whom). Build settlement API routes for recording payments and calculating optimal settlements. Create transaction-based settlement records with validation preventing negative settlements. Store amounts as integers.",
      "focusArea": "Settlement Calculation API",
      "branch": "cco/issue-401-em-5",
      "status": "pending",
      "workers": [],
      "reviewsAddressed": 0
    },
    {
      "id": 6,
      "task": "Build all UI components using shadcn/ui and React Hook Form with Zod validation. Create expense form, group create form, settlement form, invite link generator, expense list items, balance display cards, user avatars, currency formatter. Ensure keyboard accessibility and proper form error handling. Components should import shared types from src/types/.",
      "focusArea": "UI Components",
      "branch": "cco/issue-401-em-6",
      "status": "pending",
      "workers": [],
      "reviewsAddressed": 0
    },
    {
      "id": 7,
      "task": "Create all page routes and layouts using Next.js App Router. Build group dashboard (src/app/groups/[id]/page.ts), expense details page, settlement page, invite acceptance page, user profile/settings. Implement client-side data fetching with Socket.io integration for real-time updates. Create loading states and error boundaries.",
      "focusArea": "Pages & Layouts",
      "branch": "cco/issue-401-em-7",
      "status": "pending",
      "workers": [],
      "reviewsAddressed": 0
    },
    {
      "id": 8,
      "task": "Create Docker configuration for production deployment with persistent SQLite storage. Build optimized Dockerfile (multi-stage: builder + runner with node:20-alpine, standalone Next.js build). Create docker-compose.yml for local development with hot reload. Configure volume mounting for database persistence and proper environment variable management.",
      "focusArea": "Docker & Deployment",
      "branch": "cco/issue-401-em-8",
      "status": "pending",
      "workers": [],
      "reviewsAddressed": 0
    },
    {
      "id": 9,
      "task": "Implement comprehensive CI/CD pipeline with GitHub Actions. Create .github/workflows/ci.yml for linting, type-checking, and testing. Setup separate workflow for Docker image building and pushing. Configure branch protection rules and required status checks. Create release workflow for automated deployments to Railway/Fly.io.",
      "focusArea": "CI/CD Pipeline",
      "branch": "cco/issue-401-em-9",
      "status": "pending",
      "workers": [],
      "reviewsAddressed": 0
    }
  ]
}